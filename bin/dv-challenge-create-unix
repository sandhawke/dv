#!/bin/bash
source $(dv-path lib/common.sh) # -*-mode: sh-mode -*-

challenge="$1"
challenge_dir=$(dv-path challenges/$challenge)
if [ -d $challenge_dir ]; then
    log_error Already exists: $challenge_dir
    exit 1
fi

cell=$(dv-cell-create "setup-$challenge")
cd $cell

log_info Creating test suite for $challenge

cat <<_END > docs/user-request.md
We need a drop-in replacement for the unix "$challenge" program.

It must have all the POSIX behaviors and any added features that have become common in newer unix systems.

It should still be called "$challenge" so we can use it just the same.
_END

if [ -n "${2:-}" ]; then
    (echo ; echo "$2") >> docs/user-request.md
fi

git add -A; git commit -m'user request'

dv-edit-cltest-create

export COMMAND="$challenge"

dv-edit-cltest-improve-via-refimpl || log_error "Test suite still has errors"

sf="$challenge_dir/starting_files"
mkdir -p "$sf"
cp -a cltest docs "$sf"

echo "export COMMAND=\"\$PROJECT_ROOT/bin/$challenge\"" > "$sf/.env"

log_success "$sf set up"
