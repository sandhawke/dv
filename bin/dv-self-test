#!/bin/bash
source $(dv-path lib/common.sh) # -*-mode: sh-mode -*-

keys="chmod find head od sort tee touch tr uniq wc"
samples=3

cd "$(dv-cell-create self-test)"
stid=$(basename "$PWD")

mkdir logs
mkdir done
mkdir running
for sample in $(seq 1 $samples); do
    for key in $keys; do
        id=${key}_$sample
        outfile="logs/$id"
        running="running/$id"
        done="done/$id"
        echo $outfile
        date -uIseconds > "$running"
        (
            export DV_WRITE_CELL_PATH="$(mktemp)"
            script --flush --quiet --command "dv-challenge-run '$key' '$stid'" >/dev/null 2>&1 "$outfile"
            echo DV_WRITE_CELL_PATH $DV_WRITE_CELL_PATH
            cell_path="$(< "$DV_WRITE_CELL_PATH")"
            echo cell_path $cell_path
            cp -a "$outfile" "$cell_path/.dv/challenge/script-log"
            rm "$DV_WRITE_CELL_PATH"
            cp -a "$outfile" "$cell_path"
            mv "$running" "$done"
            date -uIseconds >> "$done"
            echo -n "[$id done]"
        ) &
        sleep 1 # pause for effect, used to be race condition
    done
done

echo "Processes spawned. Consider
cd '$PWD'; wc -l logs/*
cd '$PWD'; wc -l logs/*; tail -f logs/*
"
exit 0
