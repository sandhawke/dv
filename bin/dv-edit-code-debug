#!/bin/bash
source $(dv-path lib/common.sh) # -*-mode: sh-mode -*-

# Who should do this?
rm -rf _to_developer

improve="$(dv-prompt-select code-improve)"
fix="$(dv-prompt-select code-fix)"
recent="$(dv-prompt-select code-recent)"

passing=0 # we want to pass a couple times, for improvement cycle
total=0

# TODO get a list of which cltests are passing
# and if any of them start to fail, reject that
# change and instead commit a devnote with what
# the change was and why it was rejected, so we
# can avoid going down that road in the future.

while true; do
    ((total++)) || true
    # empirically, 8 seems to be a plateau on my exact setup
    if [ $total -gt 7 ]; then
        log_error "Too many debug loops ($total)"
        exit 1
    fi
    
    if dv-test; then
        ((passing++)) || true
        log_info passing $passing times
        if [ $passing -gt 0 ]; then
            echo "(improved and?) passing!"
            exit 0
        fi
        export DV_PROMPT="$improve"
    else
        if [ "$total" -gt 4 ]; then
            dv-git-include 3
            export DV_PROMPT="$recent"
        else 
            export DV_PROMPT="$fix"
        fi
    fi
    if [ -f package.json ]; then
        # just for the user
        npm test || echo npm test failed
    fi

    # while packmime can't handle EACCES in things the tests made
    chmod -R u+rX _to_developer
    
    # We're getting some baffling errors from dv-edit, like unpackmime
    # mime failing mysteriously. Check logs for 'lineno' and this.
    dv-edit || log_error "dv-edit had an error; ignoring"
done
