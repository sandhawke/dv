#!/bin/bash
source $(dv-path lib/common.sh) # -*-mode: sh-mode -*-

usage() {
    echo "Usage: $(basename $0) [options]"
    echo
    echo "Options:"
    echo "  --loop=N   Number of debug loops to run (default: 1)"
    echo "  --help     Display this help message"
    exit 1
}

# Parse command line options
loops=1
while [ $# -gt 0 ]; do
    case "$1" in
        --loop=*)
            loops="${1#*=}"
            if ! [[ "$loops" =~ ^[0-9]+$ ]]; then
                log_error "Loop count must be a positive integer"
                exit 1
            fi
            if [ "$loops" -lt 1 ]; then
                log_error "Loop count must be at least 1"
                exit 1
            fi
            ;;
        --help)
            usage
            ;;
        *)
            log_error "Unknown option: $1"
            usage
            ;;
    esac
    shift
done

# or someone else?
rm -rf _to_developer

# could branch on this
dv-test || log_warning Some tests failed

export DV_PROMPT="
We need you to implement this specification carefully, as a professional software engineer dedicated to creating bug-free easy-to-understand well-organized code.

We also need unit tests, and when appropriate, acceptance tests.

Please examine the attached material and make any necessary improvements so that we have top-quality code.
"

n=1
while [ $n -le $loops ]; do
    dv-edit

    if dv-test; then
        log_success exiting debug loop with tests passing
        exit 0
    fi

    n=$((n + 1))
done

if [ $loops -eq 1 ]; then
    log_warning "Single debug iteration completed without success"
else
    log_warning "Reached maximum number of loops ($loops) without success"
fi
exit 1
