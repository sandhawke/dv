#!/bin/bash
source $(dv-path lib/common.sh) # -*-mode: sh-mode -*-

# Who should do this?
rm -rf _to_developer

basic=""

fix="$basic

Attached, please see details on how the current code is failing one or more tests in one of the test suites.

The cltest suite is part of the program specification and must not be changed. For other tests, it is possible the error is in the test, not the program. When in doubt, add variant tests.

Please get the software working properly. You are encouraged to refactor, simplify, extend, or otherwise improve the software in any way that helps it work better.
"

improve="$basic

The current software passes all available test.

Please confirm that all specified features are tested, and clean up the code in any way that seems important.
"

recent="$basic

We still have one or more tests failing, after many tries. Look carefully at each of the recent attempts to fix it. What did they get wrong? What is a better way to fix this?
"

passing=0 # we want to pass a couple times, for improvement cycle
total=0

# TODO get a list of which cltests are passing
# and if any of them start to fail, reject that
# change and instead commit a devnote with what
# the change was and why it was rejected, so we
# can avoid going down that road in the future.

while true; do
    ((total++)) || true
    # empirically, 8 seems to be a plateau on my exact setup
    if [ $total -gt 9 ]; then
        log_error "Too many debug loops ($total)"
        exit 1
    fi
    
    if dv-test; then
        ((passing++)) || true
        log_info passing $passing times
        if [ $passing -gt 0 ]; then
            echo "(improved and?) passing!"
            exit 0
        fi
        export DV_PROMPT="$improve"
    else
        if [ "$total" -gt 4 ]; then
            dv-git-include 3
            export DV_PROMPT="$recent"
        else 
            export DV_PROMPT="$fix"
        fi
    fi

    # We're getting some baffling errors from dv-edit, like unpackmime
    # mime failing mysteriously. Check logs for 'lineno' and this.
    dv-edit || log_error "dv-edit had an error; ignoring"
done
