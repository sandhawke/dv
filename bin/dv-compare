#!/bin/bash
source $(dv-path lib/common.sh) # -*-mode: sh-mode -*-

usage() {
    cat <<EOF
Usage: dv-compare [OPTIONS] PATH1 PATH2 [PATH3...]

Copies multiple files or directories (recursively) to a temporary
directory for comparison, renaming them as option1, option2, then
asks the AI to compare them.

Options:
    --prompt='string'   Specify custom prompt for comparison
                        (default: asks for detailed comparison)
    --tag='string'      Specify prefix for renamed files (default: 'option')
    -h, --help          Show this help message

Examples:
    dv-compare file1.txt file2.txt
    dv-compare --prompt='Compare these configs' config1.yml config2.yml config3.yml
    dv-compare --tag='version' old.txt new.txt
    dv-compare --prompt='Are these translations accurate?' en fr 

Creates a temporary directory and copies all files there with
sequential numbers.  The prompt (if specified) is saved as prompt.txt
in the temporary directory.
EOF
    exit 1
}

prompt="Please compare these items in detail. Give me a full report of how they differ, include your expert judgement in ways each is superior, and if one is overall superior, say so."
tag="option"
files=()

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --prompt=*)
            prompt="${1#*=}"
            shift
            ;;
        --tag=*)
            tag="${1#*=}"
            shift
            ;;
        -h|--help)
            usage
            ;;
        *)
            files+=("$1")
            shift
            ;;
    esac
done

# Check if we have at least 2 files
if [ ${#files[@]} -lt 2 ]; then
    echo "Error: Need at least 2 files to compare" >&2
    usage
fi

# Create temp directory
tempdir=$(mktemp -d)
echo "Created temporary directory: $tempdir"

# Copy files with new names
counter=1
for file in "${files[@]}"; do
    cp -a "$file" "$tempdir/$tag$counter"
    echo "Copied $file to $tempdir/$tag$counter"
    counter=$((counter + 1))
done

# Save prompt if provided
if [ -n "$prompt" ]; then
    echo "$prompt" > "$tempdir/prompt.txt"
    echo "Saved prompt to $tempdir/prompt.txt"
fi

echo "Done. Files are in $tempdir"
