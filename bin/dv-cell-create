#!/bin/bash
source $(dv-path lib/common.sh) # -*-mode: sh-mode -*-

if [ -t 1 ]; then
    log_info 'Suggested usage:  cd $(dv-cell-create)'
fi

slug="${1:-cell}"

upper="$(dv-project-dir-upper)"
cd "$upper"

if [ -f .dv/settings/cell-root ] ; then
    cell_root="$(<.dv/settings/cell-root)"
    mkdir -p "$cell_root"
    cd "$cell_root"
    cell_root="$PWD"
else
    log_info 'Setting cell-root not set, using "." as default. Consider:

dv-settings cell-root=.          # for cells to be in-your-face
dv-settings cell-root=.dv/cells  # for cells to be hidden away

'
    cell_root="$PWD"
fi

# log_debug cell root: "$cell_root"

# log_info "Creating new cell directory with base name: $slug"

# Find the highest numbered suffix currently in use
highest=0
for dir in "$slug"-*; do
    if [ -d "$dir" ]; then
        # log_info "Found existing directory: $dir"
        suffix="${dir#$slug-}"
        if [[ "$suffix" =~ ^[0-9]+$ ]]; then
            if [ "$suffix" -gt "$highest" ]; then
                highest=$suffix
                # log_info "New highest suffix found: $highest"
            fi
        fi
    fi
done

# Increment the highest number
next=$((highest + 1))
new_dir="$slug-$next"

# log_info "Creating new directory: $new_dir"

if mkdir "$new_dir"; then
    true
    # log_success "New cell directory $new_dir"
    # echo "$new_dir"    # save for pwd at end
else
    log_error "Failed to create directory: $new_dir"
    exit 1
fi

cd "$new_dir"

dv-init

echo "$upper" > .dv/upper

pwd

for tag in "$@"; do
    # log_info adding tag "$tag"
    mkdir -p .dv/tags
    touch .dv/tags/"$tag"
done
if [ -d .dv/tags ]; then
    log_info Added tags: $(cd .dv/tags; echo *)
fi
