#!/bin/bash
source $(dv-path lib/common.sh) # -*-mode: sh-mode -*-

log_warning dv-test running
ls -altR test

# Make sure the directory is clean now, so we can clean up
# anything which tests leave behind in the main project directory
dv-git-assert-clean --message="dv-test needs a clean directory"

if [ ! -f test-all.sh ]; then
    dv-install cltest
fi

out=_to_developer/test-all.out
rm -rf "$out"
mkdir -p "$out"
export DV_CLTEST_OUT="$out/cltest.out"

function dump () {
    if [ -f "$DV_CLTEST_OUT" ]; then
        cat $DV_CLTEST_OUT
    fi
}

: ${DV_TIMEOUT:=60}

log_debug "Running test-all.sh in '$PWD' timeout $DV_TIMEOUT"
echo "### [dv-test] Running 'bash test-all.sh' with timeout of $DV_TIMEOUT seconds" >> $out/log.txt
if ! timeout --verbose $DV_TIMEOUT bash test-all.sh >> $out/log.txt 2>&1; then
    dump
    echo "### [dv-test] test-all.sh FAILED exit status $?" >> $out/log.txt
    status=1
else
    dump
    echo "test-all.sh exit status 0 -- ALL TESTS PASSED!" >> $out/log.txt
    status=0
fi

# Clean up anything which got added
git clean -fd

log_warning 'dv-test done'

exit $status
