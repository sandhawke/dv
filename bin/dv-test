#!/bin/bash
source $(dv-path lib/common.sh) # -*-mode: sh-mode -*-

: ${DV_TEST_FILE:=test-all.sh}

log_warning dv-test running

# Make sure the directory is clean now, so we can clean up
# anything which tests leave behind in the main project directory
dv-git-assert-clean --message="dv-test needs a clean directory"

cd "$(dv-project-dir)"
export PROJECT_ROOT="$(pwd)"

if [ ! -f test-all.sh ]; then
    dv-install cltest
fi

out=_to_developer/test-all.out
rm -rf "$out"
mkdir -p "$out"
export DV_CLTEST_OUT="$out/cltest.out"

function dump () {
    if [ -f "$DV_CLTEST_OUT" ]; then
        cat $DV_CLTEST_OUT
    fi
}

: ${DV_TIMEOUT:=60}

log_debug "Running ${DV_TEST_FILE} in '$PWD' timeout $DV_TIMEOUT"
echo "### [dv-test] Running 'bash ${DV_TEST_FILE}' with timeout of $DV_TIMEOUT seconds" >> $out/log.txt
if ! timeout --verbose $DV_TIMEOUT bash ${DV_TEST_FILE} >> $out/log.txt 2>&1; then
    dump
    echo "### [dv-test] ${DV_TEST_FILE} FAILED exit status $?" >> $out/log.txt
    status=1
else
    dump
    echo "${DV_TEST_FILE} exit status 0 -- ALL TESTS PASSED!" >> $out/log.txt
    status=0
fi

# Clean up anything which got added
git clean -fd

log_warning 'dv-test done'
sleep 1 # pause just a second so the user gets a glimpse

exit $status
