#!/bin/bash
source $(dv-path lib/common.sh) # -*-mode: sh-mode -*-

# Use environment variable instead of command line option
export DV_SILENT=true

# Check if current directory is a git repository
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    log_info "Not a git directory.  Consider

git init && echo .dv >> .gitignore && git add -A && git commit -m'initial files'

"
    exit 1
fi

# Check for various types of changes
untracked=$(git ls-files --others --exclude-standard)
unstaged=$(git diff --name-only)
staged=$(git diff --cached --name-only)

# If any changes are detected, provide helpful error and suggestions
if [ -n "$untracked" ] || [ -n "$unstaged" ] || [ -n "$staged" ]; then
    log_error 'Command requires there be no unsaved changes.'

    # Show what type of changes were found
    if [ -n "$untracked" ]; then
        log_info "\nUntracked files:"
        log_info "$untracked"
    fi

    if [ -n "$unstaged" ]; then
        log_info "\nUnstaged changes:"
        log_info "$unstaged"
    fi

    if [ -n "$staged" ]; then
        log_info "\nStaged changes:"
        log_info "$staged"
    fi

    log_info "
## Consider:
git status
git add -A && git commit
git clean -n   # preview what git clean would do
git clean -fd  # remove untracked files and directories
git restore .  # discard changes to tracked files
git stash      # save changes for later
"
    exit 1
fi

exit 0
